\documentclass[a4paper,11pt]{article}
\usepackage[osf]{mathpazo}
\usepackage{ms}
\usepackage{natbib}
\usepackage{lineno}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{MnSymbol}
\usepackage[osf]{mathpazo}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\modulolinenumbers[5]
\linenumbers

\pdfminorversion=3

\makeatletter
\renewcommand{\@biblabel}[1]{\quad#1.}
\makeatother

\title{A simple approach for maximizing the intersection of phylogenetic and comparative data}
\author{
Matthew W. Pennell$^{1,2,\dag,*}$, Richard G. FitzJohn$^{3,\dag}$, and William K. Cornwell$^{4}$
}

\date{}
\affiliation{
$^{1}$ Institute for Bioinformatics and Evolutionary Studies, University of Idaho, Moscow, ID 83844, U.S.A. \\
$^{2}$ Biodiversity Research Centre, University of British Columbia, Vancouver, B.C., Canada\\
$^{3}$ Department of Biological Sciences, Macquarie University, Sydney, NSW 2109, Australia\\
$^{4}$ School of Biological, Earth and Environmental Sciences, University of New South Wales, Sydney, NSW 2052\\
$^\dag$ These authors contributed equally\\
$^{*}$ Email for correspondence: \texttt{mwpennell@gmail.com}\\
}

\mstype{Applications Note}
\runninghead{Matching comparative data}
\keywords{phylogenetic comparative methods, phylogenetic community ecology, taxonomy, missing data, data imputation}


\begin{document}

\mstitlepage
\parindent=1.5em
\addtolength{\parskip}{.3em}
\vfill

\singlespacing
\section{Abstract}
\begin{enumerate}
\item Comparative biologists are increasingly using curated, public data sets to conduct large-scale phylogenetic analyses. A consequence of this is that there is often a mismatch between lineages for which there is phylogenetic data and those for which trait data is available. Researchers are commonly forced to either drop species from analyses entirely or else impute data in some way.

\item Here we point out a simple solution to mediate this problem: if some external information on topology or taxonomy is known, this can be used to exchange species in the tree that lack data for species in the data that are not placed in the phylogeny. We develop an algorithm to automatically reason through all permissable label exchanges while making minimal assumptions. This approach avoids the biases introduced by other methods.

\item We have implemented our method in a new R package \textsc{phyndr} which will allow researchers to make use of our algorithm at large scales where reasoning through and computing all permissable label exchanges becomes difficult.

\item \emph{Synthesis:} We think that \textsc{phyndr} will be a useful addition to comparative biologists' workflows, especially when used in conjuction with emerging taxonomic/phylogenetic resources and bioinformatic tools.
\end{enumerate}

\vfill

\newpage

\section{Introduction}
Researchers using phylogenetic comparative methods commonly encounter a very simple problem: some species have (phylo)genetic data but have not been measured for traits of interest and others have been measured, yet are not placed within a phylogeny. This problem has become increasingly pertinent: as the scale of phylogenetic comparative analyses expands---and fields outside of systematics find creative uses for such approaches---researchers are increasingly relying on previously published phylogenetic resources (sequence data and/or phylogenies) and trait data sets. Furthermore,  there has been a recent push to assemble, curate, and open up large collections of data for this very purpose (e.g., TreeBase, OpenTree, EOL Traitbank, TRY). 

% Should we introduce the Venn figure in the introduction.  It does set up the problem quite clearly?
Aside from gathering more data or estimating new phylogenies, the researcher is left with few options, all of which involve imputing data in some way. First, it is possible to add new taxa to the phylogeny. If one is willing to assume the monophyly of some higher taxonomic group (which may be an acceptable proposition in some clades and rather dubious in others), it is possible to paste new terminal branches into the phylogenetic tree at approximately the correct location. However, neither the topological position nor the divergence time are known: one must collapse the higher taxonomic group down to a (artificial) polytomy or else divergence times must be drawn from some distribution. Researchers have suggested using a birth-death process, parameterized from the observed data to randomly resolve polytomies \citep{Kuhn2011, ThomasPastis} \citep[see also][for a related approach for fossil trees]{Bapst2013}. For example, in a recent study \citet{Jetz2012} produced a phylogeny containing all 9,993 species of birds but 3,323 (33.2\%) of these lacked genetic data and were added in according to a constant rate birth-death process. A number of other researchers have taken up similar approaches to fill out trees for comparative analyses \citep{Price2012, Rolland2014, Jetz2014}. 

While such an approach may be very useful for many applications, such as diversification analyses \citep{Kuhn2011, Rabosky2015} randomly resolving topologies will bias inference within many comparative methods including studies of trait evolution. A number of simulation studies have investigated this effect \citep{Losos1994, Martins1996, Davies2012, Bapst2014, Rabosky2015} but the rationale is straightforward. Consider a rooted phylogeny containing 3 taxa $\mathcal{A}$, $\mathcal{B}$, and $\mathcal{C}$. There are three possible resolutions $((\mathcal{A},\mathcal{B}),\mathcal{C})$, $((\mathcal{A},\mathcal{C}),\mathcal{B})$, $((\mathcal{B},\mathcal{C}),\mathcal{A})$. If the true phylogeny is $((\mathcal{A},\mathcal{B}),\mathcal{C})$, then this will only be sampled in 1/3 of resolutions; more often than not, incorrect sister pairs will be generated. And if a trait of interest has any phylogenetic signal, then the sister species will be appear more divergent than they actually are, thus inflating the apparent rate of evolution. Of course, this problem quickly gets much worse as even more unplaced taxa are considered.

The problem of a mismatch between phylogenetic and trait data could be tackled from the other direction---lineages included in the phylogeny without a corresponding trait value in the dataset---using some sort of data imputation method. A number of recent studies have suggested approaches to accomplish this, some using the parameters of a phylogenetic model \citep{Fagan2013, Swenson2014, PEM} and another using a taxonomic sampling model \citep{FitzJohn2014}. These each have their benefits and drawbacks: using phylogenetic models assumes the observed trait values are a random sample of the distribution of trait values, an assumption that may often be egregiously violated \citep{FitzJohn2014}, whereas taxonomic-based approaches do not make full use of the structure of the phylogeny and must assume some sort of sampling distribution for the traits [clarify]. In any case, all of these involve various assumptions about the unknown states and the validity of these may be difficult to assess.

% Essentially there is a trade-off between sampling bias and introducing error.  Some approaches like Jetz et al. (2012) minimise sampling bias but introduce error.  Others try to minimize error but they often have unknown sampling bias problems.  The optimal balance between these two will depend on the particular comparative method and the question.

% If we set this up as a trade-off line, then we can say that we have a new way to (slightly improve) the sampling bias problem while not introducing more error.

All of the strategies described above are potentially useful for increasing the overlap between the tree and the comparative dataset, but as noted, they may have consequences for downstream analyses. There is, however, a much simpler approach that has to our knowledge been largely overlooked by biologists \citep[but see][for an example]{Pennell2015}: swap unmatched species in the tree with unmatched species in the data that carry equivalent information content. Consider a four taxon tree (figure 1A) of the structure $(((\mathcal{A},\mathcal{B}),\mathcal{C}),\mathcal{D})$. If our reconstructed tree contains only taxa $\mathcal{A}$, $\mathcal{C}$, and $\mathcal{D}$, such that the resulting tree is $((\mathcal{A},\mathcal{C}),\mathcal{D}$) but our dataset contains taxa $\mathcal{B}$, $\mathcal{C}$, and $\mathcal{D}$, the trait value for $\mathcal{B}$ can be swapped out for the trait value of $\mathcal{A}$ without any loss of information. If we simply dropped unmatched taxa, our analysis would only contain 2 taxa, $\mathcal{C}$ and $\mathcal{D}$, whereas if we made switched the labels of $\mathcal{A}$ and $\mathcal{B}$, we would have 3 taxa in our analysis.

This example demonstrates that if external knowledge is available, either in the form of a taxonomy or  a more comprehensive topological hypothesis, then it is possible to increase the phylogenetic coverage of the data simply by exchanging labels. Of course, simple exchanges such as the above case are logically straightforward and we suspect that this is commonly done in practice by empirical biologists \citep[e.g.,][]{Miller2013}. However, the problem quickly becomes much more complex as the number of mismatches and potential relabelings increases. Here we develop a simple algorithm to generate a set of permissible relabelings that maximizes the intersection of the phylogenetic tree and comparative data. We have created an efficient implementation of our algorithm which is available as the R package \textsc{phyndr}. We believe that this simple method could be a useful addition to the comparative biologist's workflow.

\section{Label swapping algorithm}

Definitions of terms

Description of algorithm

We conjecture---that is, we suggest without a formal proof---that our algorithm will always maximize the intersection of the species in the phylogeny and the dataset without inducing any splits that do not occur in the guide topology (whether a topotree or taxonomy).

\subsection{Using a complete topology}

OpenTree synthesis tree

\subsection{Using a taxonomic resource}

It may be more commonly the case that a taxonomic resource is available for some group. It is important to recognize that a taxonomy is in practice (if not in theory), a phylogenetic hypothesis that only contains nodes at named places on the tree. Thus our approach works just as well for this case.

It is important to be explicit about what assumptions we are making when we use a taxonomy as a guide. We are not assuming that every named higher taxonomic group is necessarily monophyletic; rather \emph{we assume that a higher taxonomic unit is monophyletic if and only if there is no phylogenetic evidence to contradict this claim}.  

Use \textsc{taxize} \citep{taxize}

\section{phyndr R package}

We have implemented our algorithm in a new R package \textsc{phyndr}. It can be downloaded from the CRAN repository (\url{http://cran.r-project.org/web/packages/phyndr/index.html}) and the development version is available on GitHub (\url{https://github.com/richfitz/phyndr}). \textsc{phyndr} relies on the \textsc{ape} \citep{ape} tree structure and \textsc{diversitree} \citep{FitzJohn2012} tree manipulation functions. \textsc{phyndr} contains two primary functions \texttt{phyndr\_taxonomy} and \texttt{phyndr\_topology} which use, as guides, taxonomies and topotrees, respectively. 

Can generate all possible combinations

\section{Examples}

\section{Discussion}

% Not sure this is the right way to start the discussion.  Need something bigger picture

In recent years, there have been increasing coordination and assemble of different across species data types including observations, traits, genes, and phylogenies (REFS).  These data sources, while already large and growing, do not overlap completely and will not do so for the foreseeable future.  As such, any type of synthetic research involving two data sources have a matching problem, and this matching problem will be increasingly common moving into the future.  We sought to find a method that increases overlap while not introducing new error.  

On one level, our method is rather obvious. If one is willing to assume that when a node it is present in both the chronogram and a topological or taxonomic hypothesis, then it can be taken as correct---and indeed, if we are not willing to make such an assumption, the phylogenetic comparative approach seems rather dubious!---our method follows from a basic property of ultrametric trees: at any node, the labels of the daughter clades are interchangeable. However, for large, complex topologies with varying degrees of conflict, it is challenging to reason through all permissible label swaps. And even for relatively simple scenarios, automating the process is non-trivial. We believe that \textsc{phyndr} will enable empirical biologists to efficiently and reliably make the most of their data.

There are a several important things to keep in mind when applying the \textsc{phyndr} algorithm to empirical data. First, as stated above, we assume that the supplied guide topology or taxonomy is accurate when it does not conflict with the topology of the chronogram. Put another way, we do not assume that higher taxonomic units are monophyletic if there is any evidence to the contrary. Nonetheless, there may be situations in which even our weak assumption is violated, especially if the hypothesized topology or taxonomy is highly unstable. Therefore, our approach is likely to be more reliable in relatively well-studied groups. Second, we technically do not generate all possible label swaps: for lineages that occur in both the tree and the trait data, we do not consider relabelings that exclude these species from the final data. If the split $(\mathcal{A,B})$ exists in the guide tree and both taxa $\mathcal{A}$ and $\mathcal{B}$ occur in our data set but only $\mathcal{A}$ is in the chronogram, it would be consistent with our algorithm to swap $\mathcal{B}$ in for $\mathcal{A}$. However, we have decide to prevent this because it requires making an additional assumption without any gain in information content. (We also note that allowing such swaps would require a more complex algorithm that the one we have proposed.) Third, we emphasize that while running analyses across multiple permutations of the datasets may be interesting and useful, this does not account for any uncertainty in topology or branch lengths and can therefore not be considered a ``posterior distribution'' or even a ``psuedo-posterior distribution'' \citep[\emph{sensu}][]{ThomasPastis}; for model-based comparative methods, it is better to consider alternative taxa sets as different realizations of the same process. And fourth, we note that our algorithm is restricted to ultrametic phylogenies; taxa are only exchangeable if they are equidistant from their most recent common ancestor, a condition that is only necessarily met when all taxa are sampled contemporaneously \citep[see][for more discussion of this point and its implications for models of trait evolution]{SlaterMEE}. So while phylogenetic approaches are becoming increasingly important for analyzing fossil and epidemiological data, alternative strategies will need to be deployed for these cases.

And importantly, while we have argued that this method is reasonable and requires few assumptions, in that it does not induce any splits in the tree or data points, there is are several important caveats to this statement. First, the tree and data that are produced are not appropriate for any diversification analyses, such as testing for trait-dependent speciation and extinction \citep[e.g.,][]{Maddison2007, FitzJohn2012} or for a correlation between rates of diversification and rates of trait evolution \citep{Rabosky2013, Rabosky2014}. The reason being that the length of terminal branches resulting from our algorithm will, on average, be longer than that expected under most models of diversification \citep[see][]{Stadler2013}. \citet{Rabosky2015} has recently argued that imputing new splits based on a birth-death process may be appropriate (or at least ``conservative'') for downstream diversification analysis, it leads to biased inferences of trait evolution. Our algorithm has the opposite statisitcal property. 

Our approach is not an alternative to various data imputation approaches but a compliment to them. While there are various potential problems with all of the types of data imputation and these should be used with great diligence, we see no reason that the simple taxon exchanges we propose should not be made unless the guide tree or topology is thought to be suspect.

Suggests a new use case for the \textsc{opentree} synthetic tree \citep{OpenTree} and for a renewed interest in taxonomy (worth noting the value of a phylogeny-based taxonomy).

\section{Concluding remarks}

\clearpage
\bibliographystyle{jecol}
\bibliography{phyndr.bib}

\end{document}
